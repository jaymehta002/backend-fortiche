import{H as he,I as U,r as u,a as xe,J as ge,j as e,A as fe,_ as h}from"./main-17S3Hvul.js";import{A as be}from"./AddCouponCodeModal-DBYn5e3n.js";import{g as ye}from"./index-Br0We1o8.js";import{D as je}from"./Dropdown-XAuyzZwj.js";import{C as Ne}from"./CircularLoader-CjEEfieY.js";import{A as ve}from"./arrow-left-Bjrxd5xc.js";import"./Button-D9xH6dL9.js";import"./cn-DUyS5Z8L.js";import"./Modal-DPih0ngx.js";import"./es.promise.resolve-DUdsJKb4.js";import"./createLucideIcon-DUHjy5LS.js";const Pe=()=>{var P,$,F,M;const[V]=he(),[k]=U(),[B,G]=u.useState([]),[J,v]=u.useState(!1),[f,R]=u.useState(null),[C,W]=u.useState(0),[c,I]=u.useState(()=>Object.keys(localStorage).filter(o=>o.startsWith("cart_")).reduce((o,l)=>{const d=JSON.parse(localStorage.getItem(l)||"[]");return[...o,...d]},[])),[Q,Y]=u.useState([]),z=xe();u.useEffect(()=>{Object.keys(localStorage).filter(t=>t.startsWith("cart_")).forEach(t=>{const o=c.filter(l=>{var d;return`cart_${l.influencerId||((d=l.recommendation)==null?void 0:d.author)||l.collectionUserId}`===t});localStorage.setItem(t,JSON.stringify(o))}),Y(c.map(t=>({productId:t._id,quantity:t.quantity,productType:t.productType})))},[c]);const[H,{isLoading:K}]=ge(),[b,D]=u.useState(!1),X=(P=c.find(s=>s.influencerId))==null?void 0:P.influencerId,Z=(F=($=c.find(s=>{var t;return(t=s.recommendation)==null?void 0:t.author}))==null?void 0:$.recommendation)==null?void 0:F.author,ee=(M=c.find(s=>s.collectionUserId))==null?void 0:M.collectionUserId,te=async()=>{var s;if(!b){D(!0);try{const t=await H({influencerId:X||Z||ee,products:Q,name:a.name,email:a.email,phone:a.phoneNumber,address:{line1:a.addressLine1,line2:a.addressLine2,additionalInfo:a.additionalInstructions,city:a.city,state:a.state,postalCode:a.postalCode,country:a.country},couponCode:f==null?void 0:f.name});window.location.href=t.data.checkoutUrl}catch(t){console.error("Checkout Error:",t),h.error(((s=t.data)==null?void 0:s.message)||"Error creating checkout"),D(!1)}}},[a,E]=u.useState({name:"",email:"",addressLine1:"",addressLine2:"",additionalInstructions:"",city:"",state:"",postalCode:"",country:"",phoneNumber:""}),se=s=>{I(t=>t.map(o=>o._id===s?{...o,quantity:o.quantity+1}:o))},ne=s=>{I(t=>t.map(o=>o._id===s&&o.quantity>1?{...o,quantity:o.quantity-1}:o))},oe=async s=>{var l,d,i;const t=c.filter(n=>n._id!==s);I(t);const o=t.reduce((n,r)=>{const p=`cart_${r.influencerId}`;return n[p]||(n[p]=[]),n[p].push(r),n},{});if(Object.keys(localStorage).filter(n=>n.startsWith("cart_")).forEach(n=>localStorage.removeItem(n)),Object.entries(o).forEach(([n,r])=>{localStorage.setItem(n,JSON.stringify(r))}),a.country)try{const n=await k({brandIds:t.map(p=>p.brandId),country:a.country});S({notDeliverable:((l=n==null?void 0:n.data)==null?void 0:l.notDeliverable)||[]});const r=O(t,((d=n==null?void 0:n.data)==null?void 0:d.shippingDetails)||[]);y(r),j(((i=n==null?void 0:n.data)==null?void 0:i.vat)||0)}catch(n){h.error("Error updating shipping costs"),console.error(n)}},w=c.reduce((s,t)=>s+t.pricing*t.quantity,0),[L,y]=u.useState(0),[T,j]=u.useState(0),re=async s=>{try{const t=c.reduce((i,n)=>(i[n.brandId]||(i[n.brandId]=[]),i[n.brandId].push(n),i),{});let o=0,l=[],d=[];for(const i of Object.keys(t))try{const n=await V({couponCode:s,brandId:i});if("error"in n){d.push(i);continue}const r=n.data.data;if(r){let p=t[i].reduce((N,x)=>N+x.pricing*x.quantity,0),g=0;if((r.applyTo.includes("SUBTOTAL")||r.applyTo.includes("DELIVERY"))&&(r.discount.type==="PERCENTAGE"?g=p*r.discount.amount/100:g=r.discount.amount),r.minimumOrderValue&&p<r.minimumOrderValue){h.error(`Coupon ${r.name} is not valid for this order. Minimum order value is €${r.minimumOrderValue}`);return}o+=g,l.push(i),R(r)}}catch{d.push(i)}l.length>0?(W(o),v(!1),d.length>0?h.success(`Coupon applied successfully to some products. Total discount: €${o.toFixed(2)}`):h.success(`Coupon applied successfully. Total discount: €${o.toFixed(2)}`)):h.error("Coupon not valid for any products in cart")}catch(t){h.error(t.message||"Error applying coupon")}},m=s=>{const{name:t,value:o}=s.target;E(l=>({...l,[t]:o}))},A=()=>!(le.notDeliverable.length>0)&&Object.entries(a).every(([t,o])=>t==="additionalInstructions"||t==="addressLine2"||t==="state"?!0:o.trim()!=="");u.useEffect(()=>{const s=ye();G(s)},[]);const ae=Object.entries(B).map(([s,t])=>t.name),[le,S]=u.useState({notDeliverable:[]}),ie=async s=>{var t,o,l,d,i;E(n=>({...n,country:s}));try{const n=c.filter(r=>r.productType!=="downloadable");if(n.length>0){const r=await k({brandIds:n.map(g=>g.brandId),country:s});if(S({notDeliverable:((t=r==null?void 0:r.data)==null?void 0:t.notDeliverable)||[]}),((l=(o=r==null?void 0:r.data)==null?void 0:o.notDeliverable)==null?void 0:l.length)>0){const N=n.filter(x=>r.data.notDeliverable.includes(x.brandId)).filter(x=>x.productType==="physical").map(x=>x.title).join(", ");h.error(`${N} ${N.includes(",")?"are":"is"} not deliverable to ${s}`),y(0),j(0);return}const p=O(n,((d=r==null?void 0:r.data)==null?void 0:d.shippingDetails)||[]);y(p),j(((i=r==null?void 0:r.data)==null?void 0:i.vat)||0)}else y(0),j(0),S({notDeliverable:[]})}catch(n){h.error("Error fetching taxes"),console.error(n)}},O=(s,t)=>{if(s.some(l=>l.productType==="downloadable"))return 0;let o=0;return s.forEach(l=>{const d=l.brandId,i=t.find(n=>n.brandId===d);if(i){const n=i.shippingCharges;o+=n}else console.log(`No shipping rules found for brand ${d}`)}),o},{data:Ce,isLoading:ce}=U({brandIds:c.map(s=>s.brandId),country:a.country}),de=w-(C||0),q=c.filter(s=>s.productType!=="downloadable").reduce((s,t)=>s+t.pricing*t.quantity,0),ue=q/w,pe=C*ue,_=(q-pe)*T||0,me=de+_+(L||0);return u.useEffect(()=>{const s=c.reduce((t,o)=>{const l=`cart_${o.influencerId}`;return t[l]||(t[l]=[]),t[l].push(o),t},{});Object.entries(s).forEach(([t,o])=>{localStorage.setItem(t,JSON.stringify(o))})},[c]),ce||K?e.jsx(fe,{}):e.jsxs(e.Fragment,{children:[J&&e.jsx(be,{onClose:()=>v(!1),handleConfirmationModal:re}),e.jsx("div",{className:"min-h-screen p-4 md:p-10",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>{z(-1)},className:"text-lg text-gray-600 font-bold mb-4",children:e.jsx(ve,{})}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Your Shopping Cart"}),e.jsx("p",{className:"text-gray-500 mt-2",children:`${c.length} Items`}),e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between ",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"mt-6 w-full space-y-4",children:c==null?void 0:c.map(s=>e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between bg-green-light p-4 rounded-lg space-y-4 md:space-y-0",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("img",{src:s.imageUrls[0],className:"w-16 h-16 bg-green-400 rounded-lg object-cover",alt:"product"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:s.title.length>20?s.title.substring(0,20)+"...":s.title||"Product Title"}),e.jsx("p",{className:"text-gray-500 px-2",children:s.brand})]}),e.jsxs("p",{className:"text-lg px-2 font-medium",children:["€",s.pricing]})]}),e.jsxs("div",{className:"flex items-center justify-between w-full md:w-auto space-x-2 md:space-x-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>se(s._id),className:"bg-white px-3 rounded-lg text-lg",children:"+"}),e.jsx("span",{className:"text-lg font-semibold",children:s.quantity.toString().padStart(2,"0")}),e.jsx("button",{onClick:()=>ne(s._id),className:"bg-white px-3 rounded-lg text-lg",children:"−"})]}),e.jsxs("p",{className:"text-lg font-semibold",children:["€",(s.pricing*s.quantity).toFixed(2)]}),e.jsx("button",{onClick:()=>oe(s._id),className:"text-red-600",children:e.jsx("img",{src:"/icons/deleteIcon.svg",alt:"delete",className:"w-6 h-6"})})]})]},s._id))})," ",e.jsxs("div",{className:" mt-8 bg-green-light p-6 rounded-lg",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Shipping Details"}),e.jsxs("form",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 font-semibold",children:"Name *"}),e.jsx("input",{type:"text",name:"name",value:a.name,onChange:m,className:"w-full px-3 py-2 border rounded-3xl  border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Enter your name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 font-semibold",children:"Email *"}),e.jsx("input",{type:"email",name:"email",value:a.email,onChange:m,className:"w-full px-3 py-2  rounded-3xl border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Enter your email",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 font-semibold",children:"Address"}),e.jsx("input",{type:"text",name:"addressLine1",value:a.addressLine1,onChange:m,className:"w-full px-3 py-2  rounded-3xl mb-2 border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Address Line 1",required:!0}),e.jsx("input",{type:"text",name:"addressLine2",value:a.addressLine2,onChange:m,className:"w-full px-3 py-2  rounded-3xl mb-2 border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Address Line 2 (optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"text",name:"city",value:a.city,onChange:m,className:"w-full px-3 py-2  rounded-3xl border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"City",required:!0}),e.jsx("input",{type:"text",name:"state",value:a.state,onChange:m,className:"w-full px-3 py-2  rounded-3xl border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"State (optional)",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[e.jsx("input",{type:"text",name:"postalCode",value:a.postalCode,onChange:m,className:"w-full px-3 py-2  rounded-3xl border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Postal Code",required:!0}),e.jsx(je,{options:ae,name:a.country,onChange:ie,value:a.country})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 font-semibold",children:"Phone Number *"}),e.jsx("input",{type:"tel",name:"phoneNumber",value:a.phoneNumber,onChange:m,className:"w-full px-3 py-2  rounded-3xl border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Enter your phone number",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 font-semibold",children:" Additional Instructions (optional)"}),e.jsx("input",{type:"text",name:"additionalInstructions",value:a.additionalInstructions,onChange:m,className:"w-full px-3 py-2 rounded-3xl mb-2 border border-green-light focus:border-green outline-none placeholder:text-sm",placeholder:"Additional Address Information (optional)"})]})]})]})]}),e.jsx("div",{className:"w-full lg:w-1/3 bg-white-pure h-fit p-6 rounded-lg mt-6  md:ml-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-bold text-lg",children:"SUBTOTAL"}),e.jsxs("p",{className:"font-semibold",children:["€",(w||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-light text-sm",children:"Shipping"}),e.jsxs("p",{className:"font-light",children:["€",L.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-light text-sm",children:"VAT"}),e.jsxs("p",{className:"font-light",children:["€",_.toFixed(2)," (",(T*100).toFixed(0),"%)"]})]}),f&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"font-bold text-lg",children:["Coupon (",f.name,")"]}),e.jsxs("p",{className:"font-semibold text-green-500",children:["−€",(C||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-bold text-lg",children:"TOTAL"}),e.jsx("p",{className:"font-semibold",children:me.toFixed(2)})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>v(!0),className:"text-green-500 font-semibold underline",children:"Apply Coupon"})}),e.jsx("button",{className:`w-full py-3 rounded-lg mt-4 text-lg flex justify-center items-center ${A()&&!b?"bg-green-500 text-white-pure":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,disabled:!A()||b,onClick:te,children:b?e.jsx(Ne,{size:"small",color:"white"}):e.jsxs(e.Fragment,{children:["Checkout",e.jsx("img",{src:"/icons/checkout.svg",alt:"checkout",className:"w-6 h-6 ml-2"})]})})]})})]})]})})]})};export{Pe as default};
